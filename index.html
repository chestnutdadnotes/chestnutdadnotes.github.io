<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4784560040134234" crossorigin="anonymous"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººç”Ÿå¾Œæ‚”è¨ˆç®—æ©Ÿ - è²¡å¯Œè¦ºé†’ç‰ˆ</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 480px; background: #1e293b; padding: 24px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; height: fit-content; padding-bottom: 60px; }
        
        h2 { margin: 0; font-size: 24px; background: linear-gradient(90deg, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .sub-title { color: #94a3b8; font-size: 13px; margin-bottom: 24px; }
        
        label { display: block; font-size: 13px; color: #cbd5e1; margin-top: 16px; margin-bottom: 6px; font-weight: 600; text-align: left; }
        
        select, input { width: 100%; padding: 14px; background: #334155; border: 2px solid #334155; border-radius: 12px; color: #fff; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        select:focus, input:focus { border-color: #38bdf8; outline: none; background: #1e293b; }
        
        button { width: 100%; padding: 16px; margin-top: 24px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-calc { background: linear-gradient(135deg, #38bdf8, #2563eb); color: white; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3); }
        .btn-calc:active { transform: scale(0.98); }
        .btn-retry { background: #334155; color: #94a3b8; margin-top: 20px; }

        /* --- å»£å‘Šç‰ˆä½è¨­å®š --- */
        #loading-section { display: none; text-align: center; padding: 20px 0; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid #38bdf8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 15px; color: #38bdf8; margin-bottom: 20px; font-weight: bold; }
        
        .ad-container { background: #fff; min-height: 280px; margin: 15px 0; border-radius: 8px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .ad-container-b { background: #fff; min-height: 100px; margin-top: 25px; border-radius: 8px; overflow: hidden; display: flex; justify-content: center; align-items: center; position: relative; padding: 5px; }
        .ad-label { position: absolute; top: 0; left: 0; background: #e2e8f0; color: #64748b; font-size: 10px; padding: 1px 6px; z-index: 10; border-bottom-right-radius: 5px; }

        /* --- çµæœé¡¯ç¤ºå€ --- */
        #result-area { display: none; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .big-val { font-size: 48px; font-weight: 800; margin: 5px 0; letter-spacing: -1px; }
        .percent-tag { display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-bottom: 15px; }
        .comment-box { background: #334155; padding: 16px; border-radius: 12px; border-left: 4px solid; margin: 20px 0; text-align: left; line-height: 1.6; color: #e2e8f0; font-style: italic; }

        .color-loss { color: #4ade80; } 
        .bg-loss { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
        .border-loss { border-color: #4ade80; }
        .color-gain { color: #f87171; }
        .bg-gain { background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .border-gain { border-color: #f87171; }

        /* --- Footer --- */
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155; font-size: 12px; color: #64748b; }
        .footer a { color: #94a3b8; text-decoration: none; transition: 0.3s; }
        .footer a:hover { color: #38bdf8; }
    </style>
</head>
<body>

<div class="container">
    <div id="input-area">
        <h2>ğŸ’¸ äººç”Ÿå¾Œæ‚”è¨ˆç®—æ©Ÿ</h2>
        <p class="sub-title">å¦‚æœé‚£å¤©å¿ä½ä¸è²·ï¼Œæ”¹è²·è‚¡ç¥¨çš„è©±...</p>
        
        <label>ğŸ”¥ é¸æ“‡ä½ éŒ¯éçš„æ¨™çš„</label>
        <select id="stockSelect">
            <optgroup label="ğŸ‡¹ğŸ‡¼ å°è‚¡ç†±é–€">
                <option value="2330" data-market="TW">å°ç©é›» (2330)</option>
                <option value="0050" data-market="TW">å…ƒå¤§å°ç£50 (0050)</option>
                <option value="2603" data-market="TW">é•·æ¦®æµ·é‹ (2603)</option>
                <option value="2454" data-market="TW">è¯ç™¼ç§‘ (2454)</option>
            </optgroup>
            <optgroup label="ğŸ‡ºğŸ‡¸ ç¾è‚¡ä¿¡ä»°">
                <option value="NVDA" data-market="US">NVIDIA (è¼é”)</option>
                <option value="TSLA" data-market="US">Tesla (ç‰¹æ–¯æ‹‰)</option>
                <option value="AAPL" data-market="US">Apple (è˜‹æœ)</option>
                <option value="MSFT" data-market="US">Microsoft (å¾®è»Ÿ)</option>
            </optgroup>
            <optgroup label="ğŸª™ åŠ å¯†è²¨å¹£">
                <option value="BTC" data-market="CRYPTO">Bitcoin (æ¯”ç‰¹å¹£)</option>
                <option value="ETH" data-market="CRYPTO">Ethereum (ä»¥å¤ªå¹£)</option>
            </optgroup>
        </select>

        <label>ğŸ“… å“ªä¸€å¤©èŠ±æ‰é€™ç­†éŒ¢ï¼Ÿ</label>
        <input type="date" id="dateInput">
        
        <label>ğŸ’¸ ç•¶æ™‚èŠ±äº†å¤šå°‘å°å¹£ (TWD)ï¼Ÿ</label>
        <input type="number" id="amountInput" placeholder="ä¾‹å¦‚ï¼š35000">
        
        <button class="btn-calc" onclick="startProcess()">é¢å°ç¾å¯¦ (é–‹å§‹è¨ˆç®—)</button>
    </div>

    <div id="loading-section">
        <div class="spinner"></div>
        <div id="loading-text" class="loading-text">æ­£åœ¨é€£ç·šè­‰äº¤æ‰€...</div>
        
        <div class="ad-container">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4784560040134234"
                 data-ad-slot="4693103259"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
        <p style="font-size: 12px; color: #64748b; margin-top: 10px;">æ•¸æ“šè¨ˆç®—ä¸­ï¼Œå»£å‘Šè¼‰å…¥å¾Œçµæœå°‡é¡¯ç¤º...</p>
    </div>

    <div id="result-area">
        <p style="font-size: 14px; color: #94a3b8; margin-top: 10px;">å¦‚æœç•¶æ™‚æŠ•å…¥ï¼Œç¾åœ¨åƒ¹å€¼ï¼š</p>
        <div class="big-val" id="finalValue">NT$ 0</div>
        <div id="percentageTag" class="percent-tag">+0%</div>
        
        <div id="commentBox" class="comment-box">è©•èªè¼‰å…¥ä¸­...</div>

        <div class="ad-container-b">
            <span class="ad-label">è´ŠåŠ©å•†å»£å‘Š</span>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-4784560040134234"
                 data-ad-slot="1109081466"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <button class="btn-retry" onclick="resetPage()">å†ä¾†ä¸€æ¬¡ (å¿ƒå¥½ç´¯)</button>
    </div>
    
    <div class="footer">
        <p>è¯ç¹«ä½œè€…ï¼š<a href="mailto:chestnutdadnotes@gmail.com">chestnutdadnotes@gmail.com</a></p>
        <p>
            *è³‡æ–™ä¾†æºï¼šFinMind / CoinGecko / æ­·å²æ•¸æ“šåº« (å«è‡ªå‹•å‚™æ´)<br>
            *ç¾è‚¡/0050 å·²é‡å°æ‹†è‚¡èˆ‡é™¤æ¬Šæ¯é€²è¡Œæ ¡æ­£ã€‚<br>
            *æœ¬å·¥å…·åƒ…ä¾›å¨›æ¨‚ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚
        </p>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸è¨­å®š ---
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    
    // ç¢ºä¿ DOM å…ƒç´ å­˜åœ¨å†æ“ä½œ
    const dateInput = document.getElementById('dateInput');
    if (dateInput) {
        dateInput.max = yesterday.toISOString().split('T')[0];
    }

    // æ–‡æ¡ˆåº«
    const comments = {
        saved: [ "ğŸ‘ æ ¹æœ¬æ˜¯å…ˆçŸ¥ï¼é€™è‚¡ç¥¨è·Œçˆ›äº†ï¼Œä½ èŠ±æ‰æ˜¯å°çš„ï¼", "æ­å–œèº²éä¸€åŠ«ï¼é€™ç­†éŒ¢èŠ±å¾—å¤ªå€¼äº†ï¼Œé¿é–‹äº†éŸ­èœå‘½é‹ã€‚", "é€™å°±æ˜¯æ¶ˆè²»æ•‘ç¶“æ¿Ÿï¼ä½ æ•‘äº†è‡ªå·±çš„è·åŒ…ï¼Œæ²’è²·æ˜¯å°çš„ã€‚" ],
        tiny: [ "é‚„å¥½å•¦ï¼Œé€™é»æ¼²å¹…é ‚å¤šè®“ä½ å¤šå–å¹¾æ¯æ˜Ÿå·´å…‹ã€‚", "æ²’ä»€éº¼å¥½å¾Œæ‚”çš„ï¼Œé€™é»éŒ¢é€£é€šè†¨éƒ½è·‘ä¸è´ã€‚", "å›æ†¶ç„¡åƒ¹ï¼é€™é»å¾®è–„çš„åˆ©æ½¤æ¯”ä¸ä¸Šä½ é‚£å¤©çš„å¿«æ¨‚ã€‚" ],
        pain: [ "å“å”·ï¼Œé€™ç­†éŒ¢ç¾åœ¨å¯ä»¥è²·ä¸€å°æ©Ÿè»Šäº†...èƒ¸å£æ‚¶æ‚¶çš„ï¼Ÿ", "ä½ è¦ªæ‰‹æ”¾æ£„äº†åŠå€‹åç‰ŒåŒ…ï¼Œå¸Œæœ›é‚£å¤©æ™šé¤å¾ˆå¥½åƒã€‚", "å¦‚æœæ˜¯è²· iPhone çš„éŒ¢ï¼Œç¾åœ¨å¯ä»¥è²·å…©æ”¯é‚„æœ‰æ‰¾äº†ã€‚" ],
        despair: [ "åˆ¥çœ‹äº†ï¼Œå¿«é—œæ‰ç¶²é ï¼é€™ç­†éŒ¢ç¾åœ¨å¯ä»¥ç›´æ¥è®“ä½ é€€ä¼‘ã€‚", "æ­å–œï¼ä½ è¦ªæ‰‹åƒæ‰äº†ä¸€å°åœ‹ç”¢è»Šã€‚éœ€è¦å«æ•‘è­·è»Šå—ï¼Ÿ", "é€™å·²ç¶“ä¸æ˜¯éŒ¯éï¼Œé€™æ˜¯çŠ¯ç½ªï¼ä½ è¬€æ®ºäº†ä½ çš„è²¡å¯Œè‡ªç”±ã€‚" ]
    };

    // å‚™æ´è³‡æ–™åº« (ç•¶ API å¤±æ•—æ™‚ä½¿ç”¨)
    const fallbackDB = {
        '2330': { current: 1050, history: { 2010:60, 2015:140, 2020:300, 2021:600, 2022:450, 2023:500, 2024:800 } },
        '0050': { current: 195, history: { 2010:55, 2015:70, 2020:90, 2021:140, 2022:110, 2023:130, 2024:170 } },
        '2603': { current: 220, history: { 2020:12, 2021:150, 2022:130, 2023:100, 2024:180 } },
        '2454': { current: 1280, history: { 2015:300, 2020:600, 2021:900, 2022:700, 2023:800 } },
        'NVDA': { current: 145, history: { 2015:0.5, 2018:6, 2020:13, 2021:30, 2022:15, 2023:48, 2024:90 } },
        'TSLA': { current: 330, history: { 2015:15, 2019:20, 2020:100, 2021:350, 2022:200, 2023:240, 2024:200 } },
        'AAPL': { current: 230, history: { 2010:10, 2015:30, 2020:80, 2021:140, 2022:130, 2023:180 } },
        'MSFT': { current: 420, history: { 2010:25, 2015:50, 2020:200, 2022:250, 2023:350 } },
        'BTC':  { current: 3000000, history: { 2015:10000, 2017:400000, 2020:300000, 2021:1500000, 2022:600000 } },
        'ETH':  { current: 100000, history: { 2016:300, 2018:30000, 2020:10000, 2021:100000, 2022:40000 } }
    };

    // --- ä¸»æµç¨‹å‡½æ•¸ ---
    async function startProcess() {
        console.log("æŒ‰éˆ•å·²é»æ“Šï¼Œé–‹å§‹è¨ˆç®—...");
        const dateInputVal = document.getElementById('dateInput').value;
        const amountInputVal = document.getElementById('amountInput').value;
        
        if (!dateInputVal || !amountInputVal) {
            alert("è«‹è¼¸å…¥å®Œæ•´çš„æ—¥æœŸå’Œé‡‘é¡ï¼");
            return;
        }

        // åˆ‡æ›é¡¯ç¤ºä»‹é¢
        document.getElementById('input-area').style.display = 'none';
        document.getElementById('loading-section').style.display = 'block';

        // å‹•æ…‹ Loading æ–‡å­—
        const loadTexts = ["æ­£åœ¨é€£ç·šè­‰äº¤æ‰€...", "æ­£åœ¨è¨ˆç®—é€šè†¨...", "æ­£åœ¨å°‹æ‰¾è®“ä½ å¿ƒç¢çš„ç†ç”±..."];
        let step = 0;
        const textInterval = setInterval(() => {
            if(step < loadTexts.length) {
                document.getElementById('loading-text').innerText = loadTexts[step];
                step++;
            }
        }, 800);

        try {
            // å¼·åˆ¶ç­‰å¾… 3.5 ç§’ (ç‚ºäº†å»£å‘Šæ•ˆæœèˆ‡å¢åŠ æœŸå¾…æ„Ÿ)
            await new Promise(resolve => setTimeout(resolve, 3500));
            
            // æŠ“å–è³‡æ–™
            const data = await fetchDataSafe(dateInputVal);
            
            clearInterval(textInterval);
            showResult(data, amountInputVal);
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('result-area').style.display = 'block';
        } catch (error) {
            console.error("åŸ·è¡ŒéŒ¯èª¤:", error);
            alert("ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            resetPage();
        }
    }

    // å®‰å…¨ç²å–æ•¸æ“š (æ··åˆ API + Fallback)
    async function fetchDataSafe(dateInput) {
        const stockSelect = document.getElementById('stockSelect');
        const stockId = stockSelect.value;
        const market = stockSelect.options[stockSelect.selectedIndex].getAttribute('data-market');
        
        let oldPrice = null;
        let currentPrice = null;

        try {
            if (market === 'CRYPTO') {
                const result = await fetchCrypto(stockId, dateInput);
                oldPrice = result.oldPrice;
                currentPrice = result.currentPrice;
            } else {
                const result = await fetchStock(stockId, market, dateInput);
                oldPrice = result.oldPrice;
                currentPrice = result.currentPrice;
            }
        } catch (e) {
            console.warn("API é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›è‡³å‚™æ´æ•¸æ“šåº«...", e);
        }

        // è‹¥ API å¤±æ•—æˆ–æ•¸æ“šç•°å¸¸ï¼Œä½¿ç”¨å…§å»ºå‚™æ´è³‡æ–™
        if (!oldPrice || !currentPrice || oldPrice === 0 || currentPrice === 0) {
            return useFallbackData(stockId, dateInput);
        }
        
        // ç°¡å–®é˜²å‘† (é˜²æ­¢ API å›å‚³éŒ¯èª¤æ¥µä½å€¼)
        if (stockId === '0050' && currentPrice < 150) currentPrice = fallbackDB['0050'].current; 
        if (stockId === '2330' && currentPrice < 800) currentPrice = fallbackDB['2330'].current;
        
        return { oldPrice, currentPrice };
    }

    // API: å°è‚¡/ç¾è‚¡ (FinMind)
    async function fetchStock(id, market, dateInput) {
        let startDate = new Date(dateInput);
        let endDate = new Date(dateInput);
        endDate.setDate(endDate.getDate() + 14); // å¾€å¾ŒæŠ“å…©é€±é¿å…å‡æ—¥ç„¡æ•¸æ“š
        
        const dataset = market === 'TW' ? 'TaiwanStockPrice' : 'USStockPrice';
        const fStartDate = startDate.toISOString().split('T')[0];
        const fEndDate = endDate.toISOString().split('T')[0];

        const hUrl = `https://api.finmindtrade.com/api/v4/data?dataset=${dataset}&data_id=${id}&start_date=${fStartDate}&end_date=${fEndDate}`;
        const hRes = await fetch(hUrl);
        const hData = await hRes.json();
        
        if (!hData.data || hData.data.length === 0) throw new Error("æ­·å²è‚¡åƒ¹æŸ¥ç„¡è³‡æ–™");
        let oldPrice = hData.data[0].Close || hData.data[0].close;

        // ç¾è‚¡æ‹†è‚¡æ ¡æ­£ (ç°¡æ˜“ç‰ˆ)
        if (id === 'NVDA') {
            if (startDate < new Date('2024-06-07')) oldPrice /= 10;
            if (startDate < new Date('2021-07-20')) oldPrice /= 4;
        }
        if (id === 'TSLA') {
            if (startDate < new Date('2022-08-25')) oldPrice /= 3;
            if (startDate < new Date('2020-08-31')) oldPrice /= 5;
        }
        if (id === 'AAPL') {
            if (startDate < new Date('2020-08-31')) oldPrice /= 4;
        }

        // æŠ“å–ç•¶å‰è‚¡åƒ¹ (æ”¹ç”¨ä¸€é€±å‰æ•¸æ“šç¢ºä¿æœ‰å€¼)
        const today = new Date();
        const pastDate = new Date();
        pastDate.setDate(today.getDate() - 7);
        const cUrl = `https://api.finmindtrade.com/api/v4/data?dataset=${dataset}&data_id=${id}&start_date=${pastDate.toISOString().split('T')[0]}`;
        const cRes = await fetch(cUrl);
        const cData = await cRes.json();
        
        if (!cData.data || cData.data.length === 0) throw new Error("ç•¶å‰è‚¡åƒ¹æŸ¥ç„¡è³‡æ–™");
        let currentPrice = cData.data[cData.data.length - 1].Close || cData.data[cData.data.length - 1].close;
        return { oldPrice, currentPrice };
    }

    // API: åŠ å¯†è²¨å¹£ (CoinGecko)
    async function fetchCrypto(id, date) {
        const d = new Date(date);
        // CoinGecko æ—¥æœŸæ ¼å¼ DD-MM-YYYY
        const gDate = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
        const coinId = id === 'BTC' ? 'bitcoin' : 'ethereum';
        
        const hUrl = `https://api.coingecko.com/api/v3/coins/${coinId}/history?date=${gDate}`;
        const cUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=twd`;
        
        const [hRes, cRes] = await Promise.all([fetch(hUrl), fetch(cUrl)]);
        const hData = await hRes.json();
        const cData = await cRes.json();
        
        if(!hData.market_data) throw new Error("åŠ å¯†è²¨å¹£ API éŒ¯èª¤");
        return { oldPrice: hData.market_data.current_price.twd, currentPrice: cData[coinId].twd };
    }

    // Fallback: ä½¿ç”¨å…§å»ºè³‡æ–™åº«
    function useFallbackData(stockId, dateInput) {
        const year = new Date(dateInput).getFullYear();
        const db = fallbackDB[stockId];
        if (!db) return { oldPrice: 100, currentPrice: 100 }; // é˜²å‘†é è¨­
        
        let oldPrice = db.history[year];
        // å¦‚æœç•¶å¹´æ²’è³‡æ–™ï¼Œæ‰¾æœ€è¿‘çš„ä¸€å¹´
        if (!oldPrice) {
            const years = Object.keys(db.history).map(Number);
            const closestYear = years.reduce((prev, curr) => Math.abs(curr - year) < Math.abs(prev - year) ? curr : prev);
            oldPrice = db.history[closestYear];
        }
        return { oldPrice: oldPrice, currentPrice: db.current };
    }

    // æ¸²æŸ“çµæœ
    function showResult(data, amount) {
        const multiplier = data.currentPrice / data.oldPrice;
        const finalVal = Math.floor(amount * multiplier);
        const profit = finalVal - amount;
        const percent = ((multiplier - 1) * 100).toFixed(2);

        const valEl = document.getElementById('finalValue');
        const tagEl = document.getElementById('percentageTag');
        const boxEl = document.getElementById('commentBox');
        
        valEl.innerText = `NT$ ${finalVal.toLocaleString()}`;
        
        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        if (profit >= 0) {
            valEl.style.color = '#f87171'; // ç´…è‰² (è³º)
            tagEl.innerText = `â–² æ¼²å¹… ${percent}% (éŒ¯éè³º NT$${profit.toLocaleString()})`;
            tagEl.className = 'percent-tag bg-gain';
            boxEl.className = 'comment-box border-gain';
            
            if (multiplier < 1.5) boxEl.innerText = getRandom(comments.tiny);
            else if (multiplier < 3) boxEl.innerText = getRandom(comments.pain);
            else boxEl.innerText = getRandom(comments.despair);
        } else {
            valEl.style.color = '#4ade80'; // ç¶ è‰² (è™§)
            tagEl.innerText = `â–¼ è·Œå¹… ${percent}% (çœäº† NT$${Math.abs(profit).toLocaleString()})`;
            tagEl.className = 'percent-tag bg-loss';
            boxEl.className = 'comment-box border-loss';
            boxEl.innerText = getRandom(comments.saved);
        }
    }

    function resetPage() {
        document.getElementById('result-area').style.display = 'none';
        document.getElementById('input-area').style.display = 'block';
        document.getElementById('amountInput').value = '';
    }
</script>

</body>
</html>